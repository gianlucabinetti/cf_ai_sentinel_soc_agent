name = "sentinel-agent"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# [observability]
# enabled = true

[ai]
binding = "AI"

[[kv_namespaces]]
binding = "SENTINEL_KV"
id = "9537df5b35e24bfd8fcd96b65c092ea4"

# Workflows binding - temporarily disabled for initial deployment
# [[workflows]]
# name = "sentinel-workflow"
# binding = "SENTINEL_WORKFLOW"
# class_name = "SentinelWorkflow"

# --- Self-Healing Cleanup (Cron Trigger) ---
# Automatically removes expired IP blocks from Cloudflare Firewall
# Runs every 30 minutes to check for expired mitigation rules
[triggers]
crons = ["*/30 * * * *"]  # Every 30 minutes

# --- SOC Integration Configuration ---
# Configure these variables to enable SOC alert integration.
# Alerts are triggered when action="block" OR riskScore > 80.
#
# Supported SOC Platforms:
# - Microsoft Sentinel: https://docs.microsoft.com/azure/sentinel/
# - Splunk HEC: https://docs.splunk.com/Documentation/Splunk/latest/Data/UsetheHTTPEventCollector
# - PagerDuty: https://developer.pagerduty.com/docs/events-api-v2/overview/
# - Custom webhooks: Any endpoint accepting POST with JSON payload
#
# Example payload structure:
# {
#   "alertId": "scan-{hash}",
#   "severity": "critical|high|medium",
#   "source": "Sentinel AI Agent",
#   "timestamp": "2026-02-04T12:00:00Z",
#   "assessment": { ... }
# }

[vars]
# SOC webhook endpoint (optional)
# Example: "https://sentinel.azure.com/api/webhooks/your-endpoint"
# Leave empty to disable SOC alerts
SOC_WEBHOOK_URL = ""

# For production, use secrets instead of vars for sensitive data:
# Run: wrangler secret put SOC_API_KEY
# Then remove the SOC_API_KEY line below
#
# SOC API authentication key (optional)
# Example: "Bearer token" or API key depending on your SOC platform
SOC_API_KEY = ""

# --- Auto-Mitigation Configuration ---
# Configure these variables to enable automatic IP blocking for critical threats.
# Auto-mitigation is triggered when riskScore >= 95.
#
# How it works:
# 1. Sentinel detects a critical threat (riskScore >= 95)
# 2. Automatically creates a Cloudflare IP Access Rule to block the source IP
# 3. Block expires after 1 hour (configurable via KV TTL)
# 4. Handles rate limits (429) with automatic retry backoff
#
# Security Notes:
# - ALWAYS use secrets for production: wrangler secret put CLOUDFLARE_API_TOKEN
# - Use a scoped API token with ONLY "Zone.Firewall Services" permissions
# - Never commit API tokens to version control
#
# How to create a scoped API token:
# 1. Go to Cloudflare Dashboard → My Profile → API Tokens
# 2. Click "Create Token" → "Create Custom Token"
# 3. Permissions: Zone → Firewall Services → Edit
# 4. Zone Resources: Include → Specific zone → [Your Zone]
# 5. Copy the token and run: wrangler secret put CLOUDFLARE_API_TOKEN

# Cloudflare API Token (optional)
# Required permissions: Zone.Firewall Services (Edit)
# Leave empty to disable auto-mitigation
CLOUDFLARE_API_TOKEN = ""

# Cloudflare Zone ID (optional)
# Find this in: Cloudflare Dashboard → [Your Domain] → Overview → Zone ID
# Example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
CLOUDFLARE_ZONE_ID = ""